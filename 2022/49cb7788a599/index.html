<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Hexo+Nginx+Trojan-Go搭建总结（Debian环境） - D-Veda&#039;s Blog</title><link rel="manifest" href="/manifest.json"><meta name="theme-color" content="#110663"><meta name="application-name" content="D-Veda&#039;s Blog"><meta name="msapplication-TileImage" content="/logo.png"><meta name="msapplication-TileColor" content="#110663"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="D-Veda&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><link rel="apple-touch-icon" sizes="72x72" href="/logo.png"><link rel="apple-touch-icon" sizes="96x96" href="/logo.png"><link rel="apple-touch-icon" sizes="128x128" href="/logo.png"><link rel="apple-touch-icon" sizes="144x144" href="/logo.png"><link rel="apple-touch-icon" sizes="256x256" href="/logo.png"><meta name="description" content="由于平时在找资料时会经常用到一些科学上网工具，但在使用过程中发现大厂服务较贵，而其他一些个人或者小团体维护的服务虽然价格相对低廉，但没有大厂稳定。当然，还是因为价格为主等其他的原因导致体验没有达到预期的效果，所以这里自己搭建一个廉价梯子。由于之前搭建梯子时使用过SS、VMESS、VLESS等其他协议，且经常发生端口被禁的现象导致网上冲浪体验就没了，所以不沿用之前的方案，又因为这个博客有一个域名，加"><meta property="og:type" content="blog"><meta property="og:title" content="Hexo+Nginx+Trojan-Go搭建总结（Debian环境）"><meta property="og:url" content="https://d-veda.top/2022/49cb7788a599/"><meta property="og:site_name" content="D-Veda&#039;s Blog"><meta property="og:description" content="由于平时在找资料时会经常用到一些科学上网工具，但在使用过程中发现大厂服务较贵，而其他一些个人或者小团体维护的服务虽然价格相对低廉，但没有大厂稳定。当然，还是因为价格为主等其他的原因导致体验没有达到预期的效果，所以这里自己搭建一个廉价梯子。由于之前搭建梯子时使用过SS、VMESS、VLESS等其他协议，且经常发生端口被禁的现象导致网上冲浪体验就没了，所以不沿用之前的方案，又因为这个博客有一个域名，加"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220318213333355.png"><meta property="og:image" content="https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220318235800950.png"><meta property="og:image" content="https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220319000623215.png"><meta property="og:image" content="https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220319001240346.png"><meta property="og:image" content="https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220319002437031.png"><meta property="og:image" content="https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220319025437213.png"><meta property="og:image" content="https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220319031526005.png"><meta property="article:published_time" content="2022-03-18T10:27:39.000Z"><meta property="article:modified_time" content="2022-03-18T16:00:00.000Z"><meta property="article:author" content="D-Veda"><meta property="article:tag" content="Hexo"><meta property="article:tag" content="Nginx"><meta property="article:tag" content="Trojan-Go"><meta property="article:tag" content="VPS"><meta property="article:tag" content="Qv2ray"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220318213333355.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://d-veda.top/2022/49cb7788a599/"},"headline":"Hexo+Nginx+Trojan-Go搭建总结（Debian环境）","image":["https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220318213333355.png","https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220318235800950.png","https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220319000623215.png","https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220319001240346.png","https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220319002437031.png","https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220319025437213.png","https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220319031526005.png"],"datePublished":"2022-03-18T10:27:39.000Z","dateModified":"2022-03-18T16:00:00.000Z","author":{"@type":"Person","name":"D-Veda"},"publisher":{"@type":"Organization","name":"D-Veda's Blog","logo":{"@type":"ImageObject","url":"https://d-veda.top/logo.png"}},"description":"由于平时在找资料时会经常用到一些科学上网工具，但在使用过程中发现大厂服务较贵，而其他一些个人或者小团体维护的服务虽然价格相对低廉，但没有大厂稳定。当然，还是因为价格为主等其他的原因导致体验没有达到预期的效果，所以这里自己搭建一个廉价梯子。由于之前搭建梯子时使用过SS、VMESS、VLESS等其他协议，且经常发生端口被禁的现象导致网上冲浪体验就没了，所以不沿用之前的方案，又因为这个博客有一个域名，加"}</script><link rel="canonical" href="https://d-veda.top/2022/49cb7788a599/"><link rel="alternate" href="/atom.xml" title="D-Veda&#039;s Blog" type="application/atom+xml"><link rel="icon" href="/logo.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/vs.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 6.0.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/logo.png" alt="D-Veda&#039;s Blog" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">主页</a><a class="navbar-item" href="/archives">档案</a><a class="navbar-item" href="/categories">分类</a><a class="navbar-item" href="/tags">标签</a></div><div class="navbar-end"><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-03-18T10:27:39.000Z" title="2022-3-18 6:27:39 ├F10: PM┤">2022-03-18</time>发表</span><span class="level-item"><time dateTime="2022-03-18T16:00:00.000Z" title="2022-3-19 12:00:00 ├F10: AM┤">2022-03-19</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/diy/">DIY</a></span><span class="level-item">27 分钟读完 (大约4013个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">Hexo+Nginx+Trojan-Go搭建总结（Debian环境）</h1><div class="content"><p>由于平时在找资料时会经常用到一些科学上网工具，但在使用过程中发现大厂服务较贵，而其他一些个人或者小团体维护的服务虽然价格相对低廉，但没有大厂稳定。当然，还是因为价格为主等其他的原因导致体验没有达到预期的效果，所以这里自己搭建一个廉价梯子。由于之前搭建梯子时使用过SS、VMESS、VLESS等其他协议，且经常发生端口被禁的现象导致网上冲浪体验就没了，所以不沿用之前的方案，又因为这个博客有一个域名，加上想把博客移到个人服务器上等原因，所以这次选择Trojan-Go协议来搭建。</p>
<span id="more"></span>

<ul>
<li>科学上网不同协议的比较选择参考</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://iyideng.vip/black-technology/cgfw/vpn-ss-ssr-v2ray-trojan-wireguard-bypass-gfw.html">科学上网工具哪个好？一灯不是和尚为您科普VPN&#x2F;SS&#x2F;SSR&#x2F;V2Ray&#x2F;Xray&#x2F;Trojan&#x2F;Trojan-Go和WireGuard的前世今生、区别和关系以及梯子软件的前景 - 一灯不是和尚 (iyideng.vip)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.techfens.com/posts/kexueshangwang.html">科学上网的主流协议大对比！这里面有你在使用的吗？ | TechFen’s Blog (techfens.com)</a></p>
</blockquote>
<p>考虑到只有一个域名且已经被用于博客了，而一个域名通常来说只解析到一个网站上。所以使用二级域名给Trojan-Go进行HTTPS的伪装，又由于想实现Hexo在个人服务器上的部署则需要使用，于是将博客同时部署到GitHub和VPS上实现网站备份的效果和科学上网。</p>
<p>在开始之前需要在原来的域名解析条目中添加一个指向VPS的<code>IP</code>条目，记录值是VPS的IP地址，效果类似如下。</p>
<div align="center">
    <img src="https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220318213333355.png" alt="阿里云域名解析控制台"  />
</div>


<p>这里使用的是阿里云的域名，其中主机记录为@表示直接解析域名（<code>d-veda.top</code>），如果存在多条记录值相同的记录会产生冲突（如果解析路线不同则可以消除冲突，最好一个域名对应一个地址）。</p>
<p><strong>注意：由于VPS只有IP能访问所以这里添加的是<code>A</code>记录，而原来域名解析指向的是域名（<code>d-veda.github.io</code>），所以用的是<code>CNAME</code>记录。这里用的境外解析路线只是避免冲突（文本所使用的方法），推荐使用二级域名指向VPS的IP地址（例如，主机记录为<code>abc</code>，已有域名为<code>xxx.com</code>，则<code>abc.xxx.com</code>为<code>xxx.com</code>的二级域名，添加一个这样的<code>A</code>记录指向VPS的IP地址即可）。</strong></p>
<p>添加完成后再将Hexo部署到VPS上。若不需要Hexo部署至VPS可以跳过下一节。</p>
<h2 id="Hexo部署推送"><a href="#Hexo部署推送" class="headerlink" title="Hexo部署推送"></a>Hexo部署推送</h2><p>Hexo是通过git推送静态网页文件到仓库的，因此，需要在VPS搭建一个git仓库（使用<code>root</code>用户）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">apt install git <span class="comment"># 安装git。</span></span><br><span class="line">adduser git <span class="comment"># 添加用户git，专用于git仓库管理。这里会提示添加用户信息和对应的密码。</span></span><br><span class="line">su git <span class="comment"># 使用git用户进行操作。</span></span><br><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">git init --bare blog.git <span class="comment"># 创建名称为blog的空仓库。</span></span><br></pre></td></tr></table></figure>

<p>这里使用<code>git</code>作为新添加的用户名是为了和常用的git代码托管平台统一，用户名可以是其他内容。使用<code>--bare</code>创建空仓库方便将仓库内容和git数据分离。</p>
<p>在创建好git仓库后，可以尝试在本地终端<code>git clone</code>一下VPS的仓库（这里会提示输入相关用户的密码）。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone git@IP:/home/git/blog.git</span><br></pre></td></tr></table></figure>

<p>这里的<code>IP</code>就是VPS的IP地址，如果VPS中的git仓库所有者不是git则需要将git修改为对应的用户名称。终端若出现如下所示的内容，则表示VPS上的仓库建立成功了。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">warning: You appear to have cloned an empty repository.</span><br></pre></td></tr></table></figure>

<hr>
<p>现在需要向本地的Hexo博客配置文件<code>_config.yml</code>中的部署参数添加VPS的git仓库信息，内容如下。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">repo:</span> </span><br><span class="line">    <span class="attr">github:</span> <span class="string">https://github.com/D-Veda/D-Veda.github.io.git</span></span><br><span class="line">    <span class="attr">VPS:</span> <span class="string">git@IP:/home/git/blog.git</span> <span class="comment"># 新添加的git仓库地址。</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>

<p>注意缩进会影响Hexo生成静态网页。<code>IP</code>替换VPS对应的IP地址，这里有两个部署的地址，前面的名称（<code>github</code>和<code>VPS</code>）是自己添加的，且可以自己定义。</p>
<p>配置好Hexo的部署地址后需要将VPS上新建的git仓库配置<code>git hook</code>（git钩子）。这么做是为了实现git仓库的自动部署。若不做git钩子进行自动部署，则在VPS中会找不到推送过来的文件（当然也可以不用git钩子，用自定义的脚本也可以实现对应的自动部署功能）。</p>
<p>配置<code>git hook</code>操作如下（使用<code>git</code>用户，不要用<code>root</code>）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim ~/blog.git/hooks/post-update.sample <span class="comment"># 修改post-update.sample文件中的命令。</span></span><br></pre></td></tr></table></figure>

<p>在<code>post-update.sample</code>文件中将原有的内容修改成如下所示的内容保存。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># An example hook script to prepare a packed repository for use over</span></span><br><span class="line"><span class="comment"># dumb transports.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># To enable this hook, rename this file to &quot;post-update&quot;.</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> git --work-tree=/var/www/blog --git-dir=/home/git/blog.git checkout -f</span><br></pre></td></tr></table></figure>

<p><strong>注意：这里的<code>--work-tree</code>对应git仓库的工作区目录（这里使用<code>/var/www/blog</code>作为工作区目录是为了对应之后的Nginx所提供的目录，也可以使用其他目录且需要自行创建），<code>--git-dir</code>对应git仓库目录，<code>checkout</code>和<code>-f</code>用于强制覆盖原有文件。</strong></p>
<p>工作区目录需要根据自己的定义的位置进行创建（这里使用<code>root</code>用户进行工作区目录的创建）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var</span><br><span class="line">mkdir www &amp;&amp; <span class="built_in">cd</span> ./www <span class="comment"># 若有www目录则不用创建，cd进入即可。</span></span><br><span class="line">mkdir blog</span><br><span class="line">chown -R git:git ./blog <span class="comment"># 将blog目录的所有者变为git用户。</span></span><br></pre></td></tr></table></figure>

<p>编辑好<code>post-update.sample</code>和创建好工作区目录后再进行如下操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">su git <span class="comment"># 使用git用户进行操作。</span></span><br><span class="line">mv ~/blog.git/hooks/post-update.sample ~/blog.git/hooks/post-update <span class="comment"># 重命名，去掉sample后缀。</span></span><br><span class="line">chmod +x ~/blog.git/hooks/post-update <span class="comment"># 给post-update文件添加可执行权限。</span></span><br></pre></td></tr></table></figure>

<p>上述操作原理参考<a target="_blank" rel="noopener" href="https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90">Git - Git 钩子 (git-scm.com)</a>。</p>
<p>配置完成后可以尝试使用<code>hexo d</code>进行部署，按照提示输入git用户密码后，将静态网页文件推送到VPS的git仓库中。推送成功后在之前的工作区目录（<code>/var/www/blog</code>）可以找到推送的文件，Hexo双部署到此就实现完成了。如果VPS工作区没有收到对应的推送文件则是前几步有误，需要自己排查。</p>
<p><strong>注意：由于Hexo是增量推送更新，所以每次<code>hexo g -d</code>如果文件内容都没有改动，Hexo不会触发git钩子进行自动部署。若要触发git钩子进行自动部署，则需要在Hexo部署前将任意内容文件稍微改动一下（随便一篇文章稍微改一下内容）并先<code>hexo clean</code>再<code>hexo g -d</code>进行生成部署。如果上述操作不能触发git钩子，则需要检查VPS中仓库的<code>post-update</code>文件、<code>hooks</code>目录和工作区目录对于<code>git</code>用户来说是否具有相应权限，还有相应文件的配置是否有误。</strong></p>
<h2 id="Nginx搭建部署"><a href="#Nginx搭建部署" class="headerlink" title="Nginx搭建部署"></a>Nginx搭建部署</h2><p>在Hexo成功部署到VPS后需要使用HTTP服务将静态网页文件显示出来，这里使用Nginx的HTTP服务，操作（使用<code>root</code>用户）如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install nginx <span class="comment"># 安装Nginx。</span></span><br></pre></td></tr></table></figure>

<p>安装完成后修改Nginx配置文件信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/nginx.conf <span class="comment"># 修改nginx.conf文件配置信息。</span></span><br></pre></td></tr></table></figure>

<p>将<code>nginx.conf</code>文件第一行的用户名改成<code>root</code>后保存，如下图所示。</p>
<div align="center">
    <img src="https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220318235800950.png" alt="nginx.conf文件配置信息"  />
</div>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/nginx/sites-available/default <span class="comment"># 修改default文件信息。</span></span><br></pre></td></tr></table></figure>

<p>将<code>default</code>文件中<code>root</code>改为自己git工作区目录，<code>server_name</code>改为自己的域名（此域名需要解析指向VPS的IP地址），如下图所示。</p>
<div align="center">
    <img src="https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220319000623215.png" alt="default文件配置信息1"  />
</div>

<p>将<code>default</code>文件最下面的<code>server</code>段内容去掉注释后把侦听端口号、服务器域名、根目录都修改成相应信息，这里使用的是8080端口避免Nginx默认情况下的80端口被占用，如下图所示。</p>
<div align="center">
    <img src="https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220319001240346.png" alt="default文件配置信息2"  />
</div>

<p>配置好文件后保存。使用<code>nginx -t</code>检测Nginx配置是否有误，以便故障排查。</p>
<hr>
<p>在Nginx完成HTTP服务配置之前需要确认VPS防火墙中相应的端口是否开启。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw status <span class="comment"># 使用ufw查看防火前端口规则列表。</span></span><br></pre></td></tr></table></figure>

<p>例如这里使用的是22、80、443、8080端口。22端口用于本地终端与VPS的SSH协议连接，80，8080用于Nginx的HTTP服务端口，443端口用于之后Trojan-Go协议的HTTPS伪装。</p>
<div align="center">
    <img src="https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220319002437031.png" alt="ufw status输出信息"  />
</div>

<p>如果防火墙端口规则列表中没有相应的端口规则，则需要手动开启相应的规则，操作如下所示。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw allow PORT</span><br></pre></td></tr></table></figure>

<p>这里的PORT替换需要放开的端口号。检查无误后重启Nginx服务，命令如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>

<p>如果Nginx提示端口被占用的错误，则可以使用<code>netstat -nlp</code>查看相应的端口占用情况，使用<code>ps -ef | grep name</code>（<code>name</code>需要被占用对应端口的应用名称替换）将对应占用端口的进程清除即可开启Nginx服务。现在可以直接使用IP访问网站，如果加载失败则需要在之前几步进行故障排查。</p>
<h2 id="申请获取SSL证书"><a href="#申请获取SSL证书" class="headerlink" title="申请获取SSL证书"></a>申请获取SSL证书</h2><p>参考Trojan-Go官方文档，从Let’s Encrypt证书颁发机构中获取证书。根据Let’s Encrypt的建议，推荐使用<a target="_blank" rel="noopener" href="https://certbot.eff.org/">Certbot</a> ACME 客户端。它可以在不下线您的服务器的前提下自动执行证书颁发和安装。</p>
<p>根据<a target="_blank" rel="noopener" href="https://certbot.eff.org/instructions?ws=nginx&os=debianbuster">Certbot 说明 |Certbot (eff.org)</a>描述，需要先将系统自带的<code>certbot</code>版本进行删除，然后安装<code>snap</code>商店中的<code>certbot</code>进行使用，具体操作如下（使用<code>root</code>用户）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apt update <span class="comment"># 更新源列表。</span></span><br><span class="line">apt install snapd <span class="comment"># 安装snapd。</span></span><br><span class="line">snap install core <span class="comment"># 获取最新的core snapd。</span></span><br><span class="line">snap refresh core <span class="comment"># 检查snap是否为最新版本。</span></span><br><span class="line">apt remove certbot <span class="comment"># 删除系统自带的certbot。</span></span><br><span class="line">apt autoremove <span class="comment"># 删除多余的依赖程序。</span></span><br><span class="line">snap install --classic certbot <span class="comment"># 使用snap安装certbot。</span></span><br><span class="line">ln -s /snap/bin/certbot /usr/bin/certbot <span class="comment"># 为certbot创建软连接，便于执行。</span></span><br><span class="line">certbot certonly --nginx <span class="comment"># 只获取证书不修改Nginx服务配置</span></span><br></pre></td></tr></table></figure>

<p>这里采用只获取证书不修改Nginx服务配置是因为若certbot修改了Nginx服务配置则会让Nginx服务开启HTTPS协议，Nginx会占用443端口，而Trojan-Go需要伪装HTTPS也要占用443。这样会造成端口冲突，所以certbot不能直接修改Nginx服务配置。在certbot获取证书失败时，需要检查域名解析是否正常工作。至此SSL证书可以成功获取。</p>
<h2 id="Trojan-Go对端搭建"><a href="#Trojan-Go对端搭建" class="headerlink" title="Trojan-Go对端搭建"></a>Trojan-Go对端搭建</h2><p>Trojan-Go使用<code>Go</code>实现的完整<code>Trojan</code>代理，兼容原版<code>Trojan协议</code>及配置文件格式。安全、高效、轻巧、易用。参考<a target="_blank" rel="noopener" href="https://github.com/p4gefau1t/trojan-go">p4gefau1t&#x2F;trojan-go</a>和<a target="_blank" rel="noopener" href="https://p4gefau1t.github.io/trojan-go/">Trojan-Go Docs</a>文档进行相应配置（使用<code>root</code>用户）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~</span><br><span class="line">wget https://github.com/p4gefau1t/trojan-go/releases/download/v0.10.6/trojan-go-linux-amd64.zip <span class="comment"># 下载Trojan-Go可执行文件。</span></span><br><span class="line">apt install unzip <span class="comment"># 安装unzip解压工具。</span></span><br><span class="line">unzip -d ./trojan-go trojan-go-linux-amd64.zip <span class="comment"># 解压官方压缩包。</span></span><br></pre></td></tr></table></figure>

<p>解压完成后，官方在<code>./example</code>目录中提供了相关的配置参考文件和服务启动参考文件，根据提供的参考文件稍作修改即可使用，操作如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ln -s /root/trojan-go/trojan-go /usr/bin/trojan-go <span class="comment"># 创建软连接，方便运行</span></span><br><span class="line"><span class="built_in">cd</span> ~/trojan-go</span><br><span class="line">mkdir config</span><br><span class="line">cp ./example/server.json ./config</span><br><span class="line">cp ./example/trojan-go.service /usr/lib/systemd/system/</span><br></pre></td></tr></table></figure>

<p>将相关的配置文件放到对应的位置后，对Trojan-Go配置进行修改，操作如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /root/trojan-go/config/server.json <span class="comment"># 修改Trojan-Go配置文件信息</span></span><br></pre></td></tr></table></figure>

<p>参考配置如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;run_type&quot;</span>: <span class="string">&quot;server&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;local_addr&quot;</span>: <span class="string">&quot;0.0.0.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;local_port&quot;</span>: <span class="number">443</span>,</span><br><span class="line">    <span class="attr">&quot;remote_addr&quot;</span>: <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;remote_port&quot;</span>: <span class="number">8080</span>,</span><br><span class="line">    <span class="attr">&quot;password&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;Your password&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;ssl&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;cert&quot;</span>: <span class="string">&quot;/path/to/your/fullchain&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;key&quot;</span>: <span class="string">&quot;/path/to/your/privkey&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;fallback_port&quot;</span>: <span class="number">8080</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意：这里的<code>remote_port</code>需要和Nginx配置的8080端口相对应，<code>cert</code>和<code>key</code>填写由certbot获取到的两个密钥文件地址，<code>fallback_port</code>作为当Trojan-Go检测到通信异常时会将数据转发到对应的端口，这里需要和Nginx所配置的8080端口对应。</strong></p>
<p>配置完成后尝试开启trojan-go服务端，查看是否运行正常，操作如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">trojan-go -config /root/trojan-go/config/server.json</span><br></pre></td></tr></table></figure>

<p>若出现如下提示且没有<code>[ERROR]</code>提示，则表示trojan-go服务端工作正常。</p>
<div align="center">
    <img src="https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220319025437213.png" alt="trojan-go运行提示"  />
</div>

<p>然后配置trojan-go的开机启动服务，操作如下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/trojan-go.service</span><br></pre></td></tr></table></figure>

<p>将启动服务文件中的<code>User</code>中的nobody改为root，检查配置文件所在地址无误保存即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Trojan-Go - An unidentifiable mechanism that helps you bypass GFW</span><br><span class="line">Documentation=https://p4gefau1t.github.io/trojan-go/</span><br><span class="line">After=network.target nss-lookup.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">User=root</span><br><span class="line">CapabilityBoundingSet=CAP_NET_ADMIN CAP_NET_BIND_SERVICE</span><br><span class="line">AmbientCapabilities=CAP_NET_ADMIN CAP_NET_BIND_SERVICE</span><br><span class="line">NoNewPrivileges=true</span><br><span class="line">ExecStart=/usr/bin/trojan-go -config /root/trojan-go/config/server.json</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>

<p>注册开机启动服务，并检测trojan-go服务运行状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> trojan-go <span class="comment"># 开机启动</span></span><br><span class="line">service trojan-go start <span class="comment"># 立即启动服务</span></span><br><span class="line">systemctl status trojan-go <span class="comment"># 检测服务运行状态</span></span><br></pre></td></tr></table></figure>

<p>trojan-go服务端的基本配置就都结束了。</p>
<hr>
<p>这里使用<a target="_blank" rel="noopener" href="https://github.com/Qv2ray/Qv2ray">Qv2ray</a>作为trojan-go客户端，在安装Qv2ray后需要将其添加<a target="_blank" rel="noopener" href="https://github.com/Qv2ray/QvPlugin-Trojan-Go">QvPlugin-Trojan-Go</a>插件才能进行连接。参考<a target="_blank" rel="noopener" href="http://qv2ray.net/lang/zh/plugins/usage.html">使用插件 | Qv2ray</a>文档安装trojan-go插件后，新建连接，需要填写的内容只有主机（填服务器的IP地址或域名）和Password（填设trojan-go服务端设置的密码），点击OK保存。</p>
<div align="center">
    <img src="https://raw.githubusercontent.com/D-Veda/D-Veda.github.io/pic/image-20220319031526005.png" alt="新建连接设置"  />
</div>

<p>完成设置后双击新建好的连接，成功即搭建完成。</p>
<p>若仍有其他问题则检查服务端和客户端的相关配置是否一致等其他问题，完成整体搭建。</p>
<h2 id="Qv2ray其他配置参考"><a href="#Qv2ray其他配置参考" class="headerlink" title="Qv2ray其他配置参考"></a>Qv2ray其他配置参考</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://gist.github.com/0xbyc/2cbae071f580e71ff055cde19efc39c4">Qv2ray高级路由设置策略</a></p>
<p><a target="_blank" rel="noopener" href="http://qv2ray.net/lang/zh/getting-started/step4.html#%E4%BD%BF%E7%94%A8%E7%B3%BB%E7%BB%9F%E4%BB%A3%E7%90%86">解决UWP应用在Qv2ray连接时不能上网的问题</a></p>
<p><a target="_blank" rel="noopener" href="https://qv2ray.net/lang/zh/manual/route.html#%E5%85%A8%E5%B1%80%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99">高级路由设置规则</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/v2ray/v2ray-core/issues/210">v2ray局域网共享方案（Qv2ray类似）</a></p>
</blockquote>
<hr>
<p>Hexo+Nginx+Trojan-Go的整体部署方案仅供参考，本文仅对搭建过程进行相关记录。</p>
</div><div class="article-licensing box"><div class="licensing-title"><p>Hexo+Nginx+Trojan-Go搭建总结（Debian环境）</p><p><a href="https://d-veda.top/2022/49cb7788a599/">https://d-veda.top/2022/49cb7788a599/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>D-Veda</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022-03-18</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2022-03-19</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/hexo/">Hexo</a><a class="link-muted mr-2" rel="tag" href="/tags/nginx/">Nginx</a><a class="link-muted mr-2" rel="tag" href="/tags/trojan-go/">Trojan-Go</a><a class="link-muted mr-2" rel="tag" href="/tags/vps/">VPS</a><a class="link-muted mr-2" rel="tag" href="/tags/qv2ray/">Qv2ray</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/680098d399fd/"><span class="level-item">基于MQTT协议的物联网云端串口波形显示小程序</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><script src="https://utteranc.es/client.js" repo="D-Veda/D-Veda.github.io" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#Hexo部署推送"><span class="level-left"><span class="level-item">1</span><span class="level-item">Hexo部署推送</span></span></a></li><li><a class="level is-mobile" href="#Nginx搭建部署"><span class="level-left"><span class="level-item">2</span><span class="level-item">Nginx搭建部署</span></span></a></li><li><a class="level is-mobile" href="#申请获取SSL证书"><span class="level-left"><span class="level-item">3</span><span class="level-item">申请获取SSL证书</span></span></a></li><li><a class="level is-mobile" href="#Trojan-Go对端搭建"><span class="level-left"><span class="level-item">4</span><span class="level-item">Trojan-Go对端搭建</span></span></a></li><li><a class="level is-mobile" href="#Qv2ray其他配置参考"><span class="level-left"><span class="level-item">5</span><span class="level-item">Qv2ray其他配置参考</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-03-18T10:27:39.000Z">2022-03-18</time></p><p class="title"><a href="/2022/49cb7788a599/">Hexo+Nginx+Trojan-Go搭建总结（Debian环境）</a></p><p class="categories"><a href="/categories/diy/">DIY</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-31T21:12:43.000Z">2022-02-01</time></p><p class="title"><a href="/2022/680098d399fd/">基于MQTT协议的物联网云端串口波形显示小程序</a></p><p class="categories"><a href="/categories/%E9%A1%B9%E7%9B%AE/">项目</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2022-01-04T15:07:11.915Z">2022-01-04</time></p><p class="title"><a href="/2022/a4beea82e0a2/">Hello World</a></p></div></article></div></div><div class="column-right-shadow is-hidden-widescreen"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="/logo.png" alt="D-Veda"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">D-Veda</p><p class="is-size-6 is-block">嵌入式新手村的快乐之条</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>赤县神州</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">2</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">8</p></a></div></div></nav><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="E-mail" href="mailto:e-alan@outlook.com"><i class="fas fa-envelope"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/D-Veda"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/atom.xml"><i class="fas fa-rss"></i></a></div></div></div><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://l1n.wang/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">l1nker4</span></span><span class="level-right"><span class="level-item tag">l1n.wang</span></span></a></li><li><a class="level is-mobile" href="https://blog.izgq.net/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">ZGQ</span></span><span class="level-right"><span class="level-item tag">blog.izgq.net</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/logo.png" alt="D-Veda&#039;s Blog" height="28"></a><p class="is-size-7"><span>&copy; 2022 D-Veda</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent " target="_blank" rel="noopener" title="这是一个新手成长的故事。满腔热血，向前！" href="/">这是一个新手成长的故事。满腔热血，向前！</a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="署名4.0 协议国际版" href="https://creativecommons.org/licenses/by/4.0/legalcode.zh-Hans"><i class="fab fa-creative-commons-by"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>